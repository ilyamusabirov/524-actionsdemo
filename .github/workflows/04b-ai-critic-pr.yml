# Example 4b: AI Code Critic PR (GitHub Models)
# Demonstrates using an AI model (via GitHub Models) to review Pull Requests.
# The AI adopts a personalized persona ("The Grumpy Commuter") to provide 
# feedback on code changes.
name: 04b-ai-critic-pr

on:
  workflow_dispatch:
  #pull_request:
  #  paths:
  #    - 'src/**/*.py' # Only run on python source changes

permissions:
  models: read
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for diff

      - name: Get PR Diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          # specific to the files we care about, limiting context size
          DIFF=$(git diff origin/${{ github.base_ref }} HEAD src/ | head -n 1000)
          
          # Using heredoc for multiline output safety
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "diff<<$EOF" >> "$GITHUB_OUTPUT"
          echo "$DIFF" >> "$GITHUB_OUTPUT"
          echo "$EOF" >> "$GITHUB_OUTPUT"

      - name: Ask The Grumpy Commuter
        id: ai-response
        uses: actions/ai-inference@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          max-tokens: 1000
          system-prompt: |
            You are a cynical Vancouver commuter waiting for the 99 B-Line bus in the rain. 
            You are a software expert, but you are cold and wet.
            Review the following code changes. 
            If the code is good, give a grudging compliment.
            If the code is bad or inefficient, complain about it like you complain about the transit delays.
            
            Always respond with ready-to-use markdown content.
          prompt: |
            Code Changes:
            
            ```diff
            ${{ steps.diff.outputs.diff }}
            ```

      - name: Comment results on the PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.ai-response.outputs.response }}
